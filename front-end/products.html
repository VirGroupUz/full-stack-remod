<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dern Market - Products</title>
    <style>
        :root {
            --bg: #ffffff;
            --muted: #6b7280;
            --border: #e5e7eb;
            --card: #f8fafc;
            --primary: #111827;
            --primary-contrast: #ffffff;
        }

        * { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; background: var(--bg); color: #111; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
        a { color: inherit; text-decoration: none; }
        .center { min-height: 100vh; display: grid; place-items: center; padding: 24px; }
        .title { margin: 0 0 8px; }
        .small { font-size: 12px; }
        .muted { color: var(--muted); }
        .mtop { margin-top: 8px; }
        .mt { margin-top: 16px; }
        .row { display: flex; align-items: center; }
        .row.gap { gap: 8px; }
        .row.between { justify-content: space-between; }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 6px 20px rgba(17, 24, 39, 0.06);
        }

        .btn {
            height: 40px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: #fff;
            padding: 0 16px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease, transform 0.06s ease, box-shadow 0.2s ease;
            will-change: transform;
        }
        .btn:hover { background: #f3f4f6; }
        .btn:active { transform: translateY(1px); }
        .btn.primary {
            background: var(--primary);
            color: var(--primary-contrast);
            border-color: var(--primary);
        }
        .btn.primary:hover { filter: brightness(0.95); }
        .btn.ghost { background: transparent; }
        .btn.outline {
            background: #fff;
            color: #111827;
            border-color: #cbd5e1;
        }
        .btn.outline:hover {
            background: #f8fafc;
            border-color: #94a3b8;
        }
        .btn.lg { height: 46px; padding: 0 18px; border-radius: 12px; font-weight: 600; }
        .btn.pill { border-radius: 9999px; }

        .form { width: 100%; max-width: 560px; display: grid; gap: 12px; }
        .input {
            width: 100%; height: 42px; border: 1px solid var(--border);
            border-radius: 10px; padding: 8px 12px; background: #fff; transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .input:focus { outline: none; border-color: #94a3b8; box-shadow: 0 0 0 3px rgba(148,163,184,0.2); }
        .input.full { grid-column: 1 / -1; }
        .label { display: grid; gap: 6px; font-size: 14px; color: #111; }

        .header {
            background: #fff;
            border-bottom: 1px solid var(--border);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .nav-links {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .cart-badge {
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            position: absolute;
            top: -8px;
            right: -8px;
        }

        .cart-icon {
            position: relative;
        }

        .filters {
            background: #f8fafc;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
        }

        .filter-row {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
        }

        .category-filter {
            min-width: 150px;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
            padding: 32px 0;
        }

        .product-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }

        .product-image {
            width: 100%;
            height: 200px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--muted);
            font-size: 48px;
        }

        .product-info {
            padding: 16px;
        }

        .product-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .product-description {
            color: var(--muted);
            font-size: 14px;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .product-price {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 12px;
        }

        .product-stock {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 16px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--muted);
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #ef4444;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .auth-form {
            display: grid;
            gap: 16px;
        }

        @media (max-width: 768px) {
            .nav-links {
                gap: 16px;
            }

            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                min-width: auto;
            }

            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 16px;
            }
        }

        @media (max-width: 480px) {
            .products-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<!-- Header -->
<header class="header">
    <div class="container">
        <nav class="nav">
            <div class="logo">Dern Market</div>
            <div class="nav-links">
                <a href="#" id="dashboardLink" style="display: none;">Dashboard</a>
                <div class="cart-icon">
                    <button class="btn ghost" id="cartBtn">
                        ðŸ›’ Cart
                        <span class="cart-badge" id="cartBadge" style="display: none;">0</span>
                    </button>
                </div>
                <button class="btn outline" id="authBtn">Login</button>
                <button class="btn ghost" id="logoutBtn" style="display: none;">Logout</button>
            </div>
        </nav>
    </div>
</header>

<!-- Filters -->
<section class="filters">
    <div class="container">
        <div class="filter-row">
            <div class="search-box">
                <input type="text" class="input" id="searchInput" placeholder="Search products...">
            </div>
            <select class="input category-filter" id="categoryFilter">
                <option value="">All Categories</option>
            </select>
            <select class="input" id="sortFilter">
                <option value="name">Sort by Name</option>
                <option value="price-low">Price: Low to High</option>
                <option value="price-high">Price: High to Low</option>
                <option value="newest">Newest First</option>
            </select>
        </div>
    </div>
</section>

<!-- Products -->
<main class="container">
    <div id="loadingState" class="loading">Loading products...</div>
    <div id="errorState" class="error" style="display: none;"></div>
    <div id="productsGrid" class="products-grid" style="display: none;"></div>
</main>

<!-- Auth Modal -->
<div id="authModal" class="modal">
    <div class="modal-content">
        <h2 id="authTitle">Login</h2>
        <form id="authForm" class="auth-form">
            <div class="label" id="nameField" style="display: none;">
                <span>Name</span>
                <input type="text" class="input" id="nameInput" placeholder="Enter your name">
            </div>
            <div class="label">
                <span>Email</span>
                <input type="email" class="input" id="emailInput" placeholder="Enter your email" required>
            </div>
            <div class="label">
                <span>Password</span>
                <input type="password" class="input" id="passwordInput" placeholder="Enter your password" required>
            </div>
            <button type="submit" class="btn primary lg">Login</button>
            <button type="button" class="btn ghost" id="toggleAuth">Don't have an account? Register</button>
            <button type="button" class="btn ghost" id="closeModal">Cancel</button>
        </form>
    </div>
</div>

<script>
    // API Configuration
    const API_BASE = 'http://localhost:5000/api';

    // State Management
    let products = [];
    let filteredProducts = [];
    let categories = new Set();
    let cartCount = 0;
    let isLoggedIn = false;
    let currentUser = null;
    let authToken = localStorage.getItem('authToken');

    // DOM Elements
    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');
    const productsGrid = document.getElementById('productsGrid');
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const sortFilter = document.getElementById('sortFilter');
    const authBtn = document.getElementById('authBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const dashboardLink = document.getElementById('dashboardLink');
    const cartBtn = document.getElementById('cartBtn');
    const cartBadge = document.getElementById('cartBadge');
    const authModal = document.getElementById('authModal');
    const authForm = document.getElementById('authForm');
    const authTitle = document.getElementById('authTitle');
    const nameField = document.getElementById('nameField');
    const nameInput = document.getElementById('nameInput');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const toggleAuth = document.getElementById('toggleAuth');
    const closeModal = document.getElementById('closeModal');

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        checkAuthStatus();
        loadProducts();
        setupEventListeners();
    });

    // Check Authentication Status
    function checkAuthStatus() {
        if (authToken) {
            try {
                const payload = JSON.parse(atob(authToken.split('.')[1]));
                if (payload.exp * 1000 > Date.now()) {
                    isLoggedIn = true;
                    currentUser = payload;
                    updateAuthUI();
                    loadCartCount();
                    return;
                }
            } catch (e) {
                console.error('Invalid token');
            }
            localStorage.removeItem('authToken');
            authToken = null;
        }
        updateAuthUI();
    }

    // Update Authentication UI
    function updateAuthUI() {
        if (isLoggedIn) {
            authBtn.style.display = 'none';
            logoutBtn.style.display = 'inline-flex';
            dashboardLink.style.display = 'inline-flex';
            dashboardLink.href = 'user-dashboard.html';
        } else {
            authBtn.style.display = 'inline-flex';
            logoutBtn.style.display = 'none';
            dashboardLink.style.display = 'none';
        }
    }

    // Setup Event Listeners
    function setupEventListeners() {
        searchInput.addEventListener('input', debounce(filterProducts, 300));
        categoryFilter.addEventListener('change', filterProducts);
        sortFilter.addEventListener('change', filterProducts);
        authBtn.addEventListener('click', () => showAuthModal('login'));
        logoutBtn.addEventListener('click', logout);
        closeModal.addEventListener('click', hideAuthModal);
        toggleAuth.addEventListener('click', toggleAuthMode);
        authForm.addEventListener('submit', handleAuth);
        cartBtn.addEventListener('click', () => {
            if (isLoggedIn) {
                window.location.href = 'user-dashboard.html#cart';
            } else {
                showAuthModal('login');
            }
        });

        // Close modal on outside click
        authModal.addEventListener('click', (e) => {
            if (e.target === authModal) hideAuthModal();
        });
    }

    // Load Products
    async function loadProducts() {
        try {
            loadingState.style.display = 'block';
            errorState.style.display = 'none';
            productsGrid.style.display = 'none';

            const response = await fetch(`${API_BASE}/products`);
            if (!response.ok) throw new Error('Failed to load products');

            products = await response.json();
            filteredProducts = [...products];

            // Extract categories
            categories.clear();
            products.forEach(product => {
                if (product.category) categories.add(product.category);
            });

            populateCategoryFilter();
            renderProducts();

            loadingState.style.display = 'none';
            productsGrid.style.display = 'grid';
        } catch (error) {
            console.error('Error loading products:', error);
            loadingState.style.display = 'none';
            errorState.textContent = 'Failed to load products. Please try again.';
            errorState.style.display = 'block';
        }
    }

    // Populate Category Filter
    function populateCategoryFilter() {
        categoryFilter.innerHTML = '<option value="">All Categories</option>';
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categoryFilter.appendChild(option);
        });
    }

    // Filter Products
    function filterProducts() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedCategory = categoryFilter.value;
        const sortBy = sortFilter.value;

        filteredProducts = products.filter(product => {
            const matchesSearch = product.name.toLowerCase().includes(searchTerm) ||
                (product.description && product.description.toLowerCase().includes(searchTerm));
            const matchesCategory = !selectedCategory || product.category === selectedCategory;
            return matchesSearch && matchesCategory;
        });

        // Sort products
        switch (sortBy) {
            case 'price-low':
                filteredProducts.sort((a, b) => a.price - b.price);
                break;
            case 'price-high':
                filteredProducts.sort((a, b) => b.price - a.price);
                break;
            case 'newest':
                filteredProducts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                break;
            default:
                filteredProducts.sort((a, b) => a.name.localeCompare(b.name));
        }

        renderProducts();
    }

    // Render Products
    function renderProducts() {
        if (filteredProducts.length === 0) {
            productsGrid.innerHTML = '<div class="error">No products found.</div>';
            return;
        }

        productsGrid.innerHTML = filteredProducts.map(product => `
                <div class="product-card">
                    <div class="product-image">ðŸ“¦</div>
                    <div class="product-info">
                        <div class="product-name">${escapeHtml(product.name)}</div>
                        <div class="product-description">${escapeHtml(product.description || 'No description available')}</div>
                        <div class="product-price">$${product.price.toFixed(2)}</div>
                        <div class="product-stock">${product.stock > 0 ? `${product.stock} in stock` : 'Out of stock'}</div>
                        <button class="btn primary" onclick="addToCart('${product._id}')"
                                ${product.stock === 0 ? 'disabled' : ''}>
                            ${product.stock === 0 ? 'Out of Stock' : 'Add to Cart'}
                        </button>
                    </div>
                </div>
            `).join('');
    }

    // Add to Cart
    async function addToCart(productId) {
        if (!isLoggedIn) {
            showAuthModal('login');
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/cart`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({
                    productId: productId,
                    quantity: 1
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Failed to add to cart');
            }

            loadCartCount();
            showNotification('Product added to cart!');
        } catch (error) {
            console.error('Error adding to cart:', error);
            showNotification('Failed to add to cart: ' + error.message, 'error');
        }
    }

    // Load Cart Count
    async function loadCartCount() {
        if (!isLoggedIn) return;

        try {
            const response = await fetch(`${API_BASE}/cart`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });

            if (response.ok) {
                const cart = await response.json();
                cartCount = cart.products ? cart.products.reduce((sum, item) => sum + item.quantity, 0) : 0;
                updateCartBadge();
            }
        } catch (error) {
            console.error('Error loading cart count:', error);
        }
    }

    // Update Cart Badge
    function updateCartBadge() {
        if (cartCount > 0) {
            cartBadge.textContent = cartCount;
            cartBadge.style.display = 'flex';
        } else {
            cartBadge.style.display = 'none';
        }
    }

    // Authentication Functions
    function showAuthModal(mode) {
        authModal.classList.add('show');
        if (mode === 'register') {
            authTitle.textContent = 'Register';
            nameField.style.display = 'block';
            nameInput.required = true;
            authForm.querySelector('button[type="submit"]').textContent = 'Register';
            toggleAuth.textContent = 'Already have an account? Login';
        } else {
            authTitle.textContent = 'Login';
            nameField.style.display = 'none';
            nameInput.required = false;
            authForm.querySelector('button[type="submit"]').textContent = 'Login';
            toggleAuth.textContent = "Don't have an account? Register";
        }
    }

    function hideAuthModal() {
        authModal.classList.remove('show');
        authForm.reset();
    }

    function toggleAuthMode() {
        const isLogin = authTitle.textContent === 'Login';
        showAuthModal(isLogin ? 'register' : 'login');
    }

    async function handleAuth(e) {
        e.preventDefault();

        const isLogin = authTitle.textContent === 'Login';
        const endpoint = isLogin ? '/auth/login' : '/auth/register';

        const data = {
            email: emailInput.value,
            password: passwordInput.value
        };

        if (!isLogin) {
            data.name = nameInput.value;
        }

        try {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || 'Authentication failed');
            }

            authToken = result.token;
            localStorage.setItem('authToken', authToken);
            isLoggedIn = true;
            currentUser = result.user;

            updateAuthUI();
            hideAuthModal();
            loadCartCount();
            showNotification(isLogin ? 'Logged in successfully!' : 'Account created successfully!');
        } catch (error) {
            console.error('Auth error:', error);
            showNotification('Authentication failed: ' + error.message, 'error');
        }
    }

    function logout() {
        localStorage.removeItem('authToken');
        authToken = null;
        isLoggedIn = false;
        currentUser = null;
        cartCount = 0;
        updateAuthUI();
        updateCartBadge();
        showNotification('Logged out successfully!');
    }

    // Utility Functions
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 24px;
                background: ${type === 'error' ? '#ef4444' : '#10b981'};
                color: white;
                border-radius: 8px;
                z-index: 1001;
                animation: slideIn 0.3s ease;
            `;
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
    document.head.appendChild(style);
</script>
</body>
</html>
