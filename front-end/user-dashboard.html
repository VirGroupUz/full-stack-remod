<!doctype html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dern Market - Foydalanuvchi Paneli</title>
  <style>
    :root {
      --bg: #ffffff;
      --muted: #6b7280;
      --border: #e5e7eb;
      --card: #f8fafc;
      --primary: #111827;
      --primary-contrast: #ffffff;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      background: radial-gradient(1200px 600px at -10% -10%, #eef2ff 0%, transparent 50%),
      radial-gradient(1200px 600px at 110% -10%, #fef9c3 0%, transparent 50%);
      color: #111;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    a { color: inherit; text-decoration: none; }
    .center { min-height: 100vh; display: grid; place-items: center; padding: 24px; }
    .title { margin: 0 0 8px; }
    .small { font-size: 12px; }
    .muted { color: var(--muted); }
    .mtop { margin-top: 8px; }
    .mt { margin-top: 16px; }
    .row { display: flex; align-items: center; }
    .row.gap { gap: 8px; }
    .row.between { justify-content: space-between; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 20px rgba(17, 24, 39, 0.06);
    }
    .btn {
      height: 40px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      padding: 0 16px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s ease;
      will-change: transform;
      font-size: 14px;
      font-weight: 500;
    }
    .btn:hover { background: #f3f4f6; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn.primary {
      background: var(--primary);
      color: var(--primary-contrast);
      border-color: var(--primary);
    }
    .btn.primary:hover { filter: brightness(0.95); }
    .btn.ghost { background: transparent; border-color: transparent; }
    .btn.outline {
      background: #fff;
      color: #111827;
      border-color: #cbd5e1;
    }
    .btn.outline:hover {
      background: #f8fafc;
      border-color: #94a3b8;
    }
    .btn.lg { height: 46px; padding: 0 18px; border-radius: 12px; font-weight: 600; }
    .btn.pill { border-radius: 9999px; }
    .btn.danger {
      background: var(--error);
      color: white;
      border-color: var(--error);
    }
    .btn.danger:hover { filter: brightness(0.9); }
    .btn.success {
      background: var(--success);
      color: white;
      border-color: var(--success);
    }
    .btn.success:hover { filter: brightness(0.9); }
    .form { width: 100%; max-width: 560px; display: grid; gap: 12px; }
    .input {
      width: 100%; height: 42px; border: 1px solid var(--border);
      border-radius: 10px; padding: 8px 12px; background: #fff;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .input:focus { outline: none; border-color: #94a3b8; box-shadow: 0 0 0 3px rgba(148,163,184,0.2); }
    .input.full { grid-column: 1 / -1; }
    .label { display: grid; gap: 6px; font-size: 14px; color: #111; }
    .dashboard-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: 100vh;
    }
    .sidebar {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-right: 1px solid var(--border);
      padding: 24px 16px;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }
    .main-content {
      padding: 24px;
      overflow-x: hidden;
    }
    .topbar {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      margin: -24px -24px 24px -24px;
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 32px;
    }
    .brand-logo {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary) 0%, #374151 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .brand-text {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
    }
    .nav-section {
      margin-bottom: 24px;
    }
    .nav-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      padding: 0 12px;
    }
    .nav-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 10px;
      color: #374151;
      transition: all 0.2s ease;
      margin-bottom: 4px;
      font-weight: 500;
    }
    .nav-link:hover {
      background: #f3f4f6;
      color: var(--primary);
    }
    .nav-link.active {
      background: #eef2ff;
      color: var(--primary);
      border: 1px solid #e0e7ff;
    }
    .nav-icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    .page-header {
      margin-bottom: 24px;
    }
    .page-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
      margin: 0 0 8px 0;
    }
    .page-subtitle {
      color: var(--muted);
      margin: 0;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }
    .stat-label {
      font-size: 14px;
      color: var(--muted);
    }
    .cart-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 12px;
      background: white;
    }
    .cart-item-info {
      flex: 1;
    }
    .cart-item-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .cart-item-price {
      color: var(--muted);
      font-size: 14px;
    }
    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .quantity-btn {
      width: 32px;
      height: 32px;
      border: 1px solid var(--border);
      background: white;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }
    .quantity-btn:hover {
      background: #f3f4f6;
    }
    .quantity-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .order-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      background: white;
    }
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .order-id {
      font-weight: 600;
      font-size: 16px;
    }
    .order-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-processing { background: #dbeafe; color: #1e40af; }
    .status-shipped { background: #d1fae5; color: #065f46; }
    .status-delivered { background: #dcfce7; color: #166534; }
    .order-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #f3f4f6;
    }
    .order-date {
      color: var(--muted);
      font-size: 14px;
    }
    .order-total {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
    }
    .order-items {
      margin-top: 12px;
    }
    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    .order-item:last-child {
      border-bottom: none;
    }
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #e5e7eb;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }
    .empty-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      opacity: 0.5;
    }
    .cart-total {
      background: #f8fafc;
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
    }
    .total-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .total-row.final {
      font-weight: 700;
      font-size: 18px;
      border-top: 1px solid var(--border);
      padding-top: 12px;
      margin-top: 12px;
    }
    .profile-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }
    .profile-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }
    .profile-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .profile-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--primary);
    }
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }
    .product-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .product-name {
      font-weight: 600;
      font-size: 18px;
      margin-bottom: 4px;
    }
    .product-description {
      font-size: 14px;
      color: var(--muted);
      flex-grow: 1;
    }
    .product-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
    }
    .product-price {
      font-size: 20px;
      font-weight: 700;
    }
    .faq-item {
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 12px;
    }
    .faq-question {
      font-weight: 600;
      font-size: 18px;
      margin-bottom: 8px;
    }
    .faq-answer {
      color: var(--muted);
      font-size: 15px;
    }
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
    }
    .analytics-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }
    .analytics-title {
      font-weight: 600;
      font-size: 18px;
      margin-bottom: 12px;
    }
    .analytics-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .analytics-list-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f3f4f6;
      font-size: 14px;
    }
    .analytics-list-item:last-child {
      border-bottom: none;
    }
    @media (max-width: 920px) {
      .dashboard-layout {
        grid-template-columns: 1fr;
      }
      .sidebar {
        position: static;
        height: auto;
        border-right: none;
        border-bottom: 1px solid var(--border);
        padding: 16px;
      }
      .brand {
        margin-bottom: 16px;
      }
      .nav-section {
        margin-bottom: 16px;
      }
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .cart-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      .order-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      .order-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
    }
    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .profile-grid {
        grid-template-columns: 1fr;
      }
      .product-grid {
        grid-template-columns: 1fr;
      }
      .analytics-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<div class="dashboard-layout">
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-logo">
        <svg class="nav-icon" fill="white" viewBox="0 0 24 24">
          <path d="M12 2L2 7v10c0 5.55 3.84 9.739 9 11 5.16-1.261 9-5.45 9-11V7l-10-5z"/>
        </svg>
      </div>
      <div class="brand-text">Dern‑Market</div>
    </div>
    <nav>
      <div class="nav-section">
        <div class="nav-title">Asosiy</div>
        <a href="#" data-section="profile" class="nav-link active">
          <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
          </svg>
          Profil
        </a>
        <a href="#" data-section="products" class="nav-link">
          <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
          Mahsulotlar
        </a>
        <a href="#" data-section="cart" class="nav-link">
          <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
            <path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
          </svg>
          Savatcha
        </a>
        <a href="#" data-section="orders" class="nav-link">
          <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
            <path d="M19 7h-3V6a4 4 0 0 0-8 0v1H5a1 1 0 0 0-1 1v11a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V8a1 1 0 0 0-1-1zM10 6a2 2 0 0 1 4 0v1h-4V6zm8 13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V9h2v1a1 1 0 0 0 2 0V9h4v1a1 1 0 0 0 2 0V9h2v10z"/>
          </svg>
          Buyurtmalar
        </a>
      </div>
      <div class="nav-section">
        <div class="nav-title">Boshqa</div>
        <a href="#" data-section="faq" class="nav-link">
          <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 14h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
          </svg>
          FAQ
        </a>
        <a href="#" data-section="analytics" class="nav-link admin-only">
          <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
          </svg>
          Tahlillar
        </a>
      </div>
    </nav>
  </aside>
  <main class="main-content">
    <div class="topbar">
      <h1 id="pageTitle" class="page-title">Profil</h1>
      <div class="row gap">
        <span id="userGreeting" class="muted">Xush kelibsiz!</span>
        <button class="btn outline" id="logoutBtn">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
            <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5-5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
          </svg>
          Chiqish
        </button>
      </div>
    </div>
    <div id="profile" class="section active">
      <div class="page-header">
        <h2 class="page-title">Foydalanuvchi Profili</h2>
        <p class="page-subtitle">Shaxsiy ma'lumotlaringizni ko'ring</p>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalOrders">0</div>
          <div class="stat-label">Jami buyurtmalar</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="cartItems">0</div>
          <div class="stat-label">Savatcha mahsulotlari</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalSpent">$0</div>
          <div class="stat-label">Jami xarajat</div>
        </div>
      </div>
      <div id="profileInfo" class="loading">
        <div class="spinner"></div>
        Ma'lumotlar yuklanmoqda...
      </div>
    </div>
    <div id="products" class="section">
      <div class="page-header">
        <h2 class="page-title">Mahsulotlar</h2>
        <p class="page-subtitle">Xarid uchun mahsulotlarni tanlang</p>
      </div>
      <div class="row gap mt">
        <input type="text" id="productSearchInput" class="input" placeholder="Mahsulotlarni qidirish...">
      </div>
      <div id="productsContent" class="loading mt">
        <div class="spinner"></div>
        Mahsulotlar yuklanmoqda...
      </div>
    </div>
    <div id="cart" class="section">
      <div class="page-header">
        <h2 class="page-title">Savatcha</h2>
        <p class="page-subtitle">Tanlangan mahsulotlaringizni boshqaring</p>
      </div>
      <div id="cartContent" class="loading">
        <div class="spinner"></div>
        Savatcha yuklanmoqda...
      </div>
    </div>
    <div id="orders" class="section">
      <div class="page-header">
        <h2 class="page-title">Buyurtmalar tarixi</h2>
        <p class="page-subtitle">Barcha buyurtmalaringizni ko'ring va kuzating</p>
      </div>
      <div id="ordersContent" class="loading">
        <div class="spinner"></div>
        Buyurtmalar yuklanmoqda...
      </div>
    </div>
    <div id="faq" class="section">
      <div class="page-header">
        <h2 class="page-title">Ko‘p so‘raladigan savollar</h2>
        <p class="page-subtitle">Tez-tez beriladigan savollar va javoblar</p>
      </div>
      <div id="faqContent" class="loading">
        <div class="spinner"></div>
        Savollar yuklanmoqda...
      </div>
    </div>
    <div id="analytics" class="section">
      <div class="page-header">
        <h2 class="page-title">Tahlillar</h2>
        <p class="page-subtitle">Sotuvlar, eng yaxshi mahsulotlar va foydalanuvchi faolligi</p>
      </div>
      <div id="analyticsContent" class="loading">
        <div class="spinner"></div>
        Tahlillar yuklanmoqda...
      </div>
    </div>
  </main>
</div>
<script>
  const API_BASE = 'http://localhost:5000/api';
  const TOKEN_KEY = 'dm_token';
  const USER_KEY = 'dm_user';
  let currentUser = null;
  let authToken = localStorage.getItem(TOKEN_KEY);
  let cartData = null;
  let ordersData = [];
  let productsData = [];
  let faqsData = [];
  let salesReportData = [];
  let topProductsData = [];
  let userActivityData = [];
  const navLinks = document.querySelectorAll('.nav-link');
  const sections = document.querySelectorAll('.section');
  const pageTitle = document.getElementById('pageTitle');
  const userGreeting = document.getElementById('userGreeting');
  const logoutBtn = document.getElementById('logoutBtn');
  const profileInfo = document.getElementById('profileInfo');
  const ordersContent = document.getElementById('ordersContent');
  const cartContent = document.getElementById('cartContent');
  const productsContent = document.getElementById('productsContent');
  const faqContent = document.getElementById('faqContent');
  const analyticsContent = document.getElementById('analyticsContent');
  const totalOrdersStat = document.getElementById('totalOrders');
  const cartItemsStat = document.getElementById('cartItems');
  const totalSpentStat = document.getElementById('totalSpent');
  const productSearchInput = document.getElementById('productSearchInput');

  function getUserFromLocalStorage() {
    try {
      const raw = localStorage.getItem(USER_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch {
      return null;
    }
  }

  function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
  }

  function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      background: ${type === 'error' ? 'var(--error)' : 'var(--success)'};
      color: white;
      border-radius: 12px;
      z-index: 1001;
      animation: slideIn 0.3s ease;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      font-weight: 500;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => notification.remove(), 300);
    }, 4000);
  }

  async function apiFetch(path, options = {}) {
    const headers = {
      'Content-Type': 'application/json',
      ...options.headers,
    };
    if (authToken) {
      headers['Authorization'] = `Bearer ${authToken}`;
    }
    const res = await fetch(`${API_BASE}${path}`, {
      ...options,
      headers,
    });
    if (!res.ok) {
      let message = 'Request failed';
      try {
        const err = await res.json();
        message = err?.message || message;
      } catch {
      }
      throw new Error(message);
    }
    if (res.status === 204) return null;
    return res.json();
  }

  document.addEventListener('DOMContentLoaded', function() {
    checkAuth();
    setupEventListeners();
    handleHashNavigation();
  });

  function checkAuth() {
    if (!authToken) {
      window.location.href = 'login.html';
      return;
    }
    try {
      const payload = JSON.parse(atob(authToken.split('.')[1]));
      if (payload.exp * 1000 <= Date.now()) {
        localStorage.removeItem(TOKEN_KEY);
        localStorage.removeItem(USER_KEY);
        window.location.href = 'login.html';
        return;
      }
      currentUser = getUserFromLocalStorage() || payload;
      updateUserGreeting();
      updateAdminVisibility();
      loadUserData();
    } catch (e) {
      localStorage.removeItem(TOKEN_KEY);
      localStorage.removeItem(USER_KEY);
      window.location.href = 'login.html';
    }
  }

  function updateUserGreeting() {
    if (currentUser && userGreeting) {
      userGreeting.textContent = `Xush kelibsiz, ${escapeHtml(currentUser.name || currentUser.email)}!`;
    }
  }

  function updateAdminVisibility() {
    const adminLinks = document.querySelectorAll('.admin-only');
    if (currentUser && currentUser.role === 'admin') {
      adminLinks.forEach(link => link.style.display = 'flex');
    } else {
      adminLinks.forEach(link => link.style.display = 'none');
    }
  }

  function setupEventListeners() {
    navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const section = link.dataset.section;
        if (section) {
          showSection(section);
          window.location.hash = section;
        }
      });
    });
    logoutBtn.addEventListener('click', logout);
    productSearchInput.addEventListener('input', renderProducts);
    window.addEventListener('hashchange', handleHashNavigation);
  }

  function handleHashNavigation() {
    const hash = window.location.hash.substring(1);
    if (hash && ['profile', 'products', 'orders', 'cart', 'faq', 'analytics'].includes(hash)) {
      showSection(hash);
    } else {
      showSection('profile');
    }
  }

  function showSection(sectionName) {
    navLinks.forEach(link => {
      link.classList.remove('active');
      if (link.dataset.section === sectionName) {
        link.classList.add('active');
      }
    });
    sections.forEach(section => {
      section.classList.remove('active');
    });
    document.getElementById(sectionName).classList.add('active');
    const titles = {
      profile: 'Profil',
      products: 'Mahsulotlar',
      orders: 'Buyurtmalar',
      cart: 'Savatcha',
      faq: 'Ko‘p so‘raladigan savollar',
      analytics: 'Tahlillar'
    };
    pageTitle.textContent = titles[sectionName] || 'Dashboard';
    switch (sectionName) {
      case 'profile':
        loadProfile();
        break;
      case 'products':
        loadProducts();
        break;
      case 'orders':
        loadOrders();
        break;
      case 'cart':
        loadCart();
        break;
      case 'faq':
        loadFaqs();
        break;
      case 'analytics':
        loadAnalytics();
        break;
    }
  }

  async function loadUserData() {
    await Promise.all([
      loadStats()
    ]);
  }

  async function loadStats() {
    try {
      const orders = await apiFetch('/orders');
      ordersData = orders;
      totalOrdersStat.textContent = orders.length;
      const spent = orders.reduce((sum, order) => sum + order.total, 0);
      totalSpentStat.textContent = `$${spent.toFixed(2)}`;
      const cart = await apiFetch('/cart');
      cartData = cart;
      const itemCount = cart.products ? cart.products.reduce((sum, item) => sum + item.quantity, 0) : 0;
      cartItemsStat.textContent = itemCount;
    } catch (error) {
      console.error('Error loading stats:', error);
      totalOrdersStat.textContent = 'N/A';
      cartItemsStat.textContent = 'N/A';
      totalSpentStat.textContent = 'N/A';
    }
  }

  function loadProfile() {
    if (!currentUser) {
      profileInfo.innerHTML = `
        <div class="empty-state">
          <p>Foydalanuvchi ma'lumotlari yuklanmadi.</p>
        </div>
      `;
      return;
    }
    profileInfo.innerHTML = `
      <div class="profile-grid">
        <div class="profile-card">
          <div class="profile-label">Ism</div>
          <div class="profile-value">${escapeHtml(currentUser.name || 'Kiritilmagan')}</div>
        </div>
        <div class="profile-card">
          <div class="profile-label">Email</div>
          <div class="profile-value">${escapeHtml(currentUser.email || 'Kiritilmagan')}</div>
        </div>
        <div class="profile-card">
          <div class="profile-label">Rol</div>
          <div class="profile-value">${escapeHtml(currentUser.role === 'admin' ? 'Administrator' : 'Foydalanuvchi')}</div>
        </div>
        <div class="profile-card">
          <div class="profile-label">A'zo bo'lgan sana</div>
          <div class="profile-value">${currentUser.iat ? new Date(currentUser.iat * 1000).toLocaleDateString('uz-UZ') : 'Noma\'lum'}</div>
        </div>
      </div>
    `;
  }

  async function loadProducts() {
    productsContent.innerHTML = `
      <div class="loading">
        <div class="spinner"></div>
        Mahsulotlar yuklanmoqda...
      </div>
    `;
    try {
      const products = await apiFetch('/products');
      productsData = products;
      renderProducts();
    } catch (error) {
      console.error('Error loading products:', error);
      productsContent.innerHTML = `
        <div class="empty-state">
          <svg class="empty-icon" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          <p>Mahsulotlarni yuklashda xatolik yuz berdi.</p>
          <button class="btn primary" onclick="loadProducts()">Qayta urinish</button>
        </div>
      `;
    }
  }

  function renderProducts() {
    const query = productSearchInput.value.toLowerCase();
    const filteredProducts = productsData.filter(p =>
            p.name.toLowerCase().includes(query) || (p.description || '').toLowerCase().includes(query)
    );
    if (filteredProducts.length === 0) {
      productsContent.innerHTML = `
        <div class="empty-state">
          <svg class="empty-icon" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          <p>Mahsulot topilmadi.</p>
          <button class="btn primary" onclick="productSearchInput.value=''; renderProducts();">Qidiruvni tozalash</button>
        </div>
      `;
      return;
    }
    productsContent.innerHTML = `
      <div class="product-grid">
        ${filteredProducts.map(p => `
          <div class="product-card">
            <div class="product-name">${escapeHtml(p.name)}</div>
            <div class="product-description">${escapeHtml(p.description || 'Mahsulot tavsifi yo‘q.')}</div>
            <div class="product-footer">
              <div class="product-price">$${p.price.toFixed(2)}</div>
              <button class="btn primary" onclick="addToCartAndGoToCart('${p._id}')">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                </svg>
                Savatchaga
              </button>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }

  async function addToCartAndGoToCart(productId) {
    try {
      // This uses POST, which maps to addOrIncrementCartItem on the backend
      await apiFetch('/cart', {
        method: 'POST',
        body: JSON.stringify({ productId: productId, quantity: 1 })
      });
      showNotification('Mahsulot savatchaga qo‘shildi!');
      loadStats();
      showSection('cart');
    } catch (error) {
      console.error('Error adding to cart:', error);
      showNotification('Mahsulotni savatchaga qo‘shishda xatolik', 'error');
    }
  }

  async function loadCart() {
    cartContent.innerHTML = `
      <div class="loading">
        <div class="spinner"></div>
        Savatcha yuklanmoqda...
      </div>
    `;
    try {
      const cart = await apiFetch('/cart');
      cartData = cart;
      renderCart();
    } catch (error) {
      console.error('Error loading cart:', error);
      cartContent.innerHTML = `
        <div class="empty-state">
          <svg class="empty-icon" fill="currentColor" viewBox="0 0 24 24">
            <path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
          </svg>
          <p>Savatchani yuklashda xatolik yuz berdi.</p>
          <button class="btn primary" onclick="loadCart()">Qayta urinish</button>
        </div>
      `;
    }
  }

  function renderCart() {
    if (!cartData || !cartData.products || cartData.products.length === 0) {
      cartContent.innerHTML = `
        <div class="empty-state">
          <svg class="empty-icon" fill="currentColor" viewBox="0 0 24 24">
            <path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
          </svg>
          <p>Savatchangiz bo'sh.</p>
          <a href="#" data-section="products" class="btn primary" onclick="showSection('products');">Xarid qilishni boshlash</a>
        </div>
      `;
      return;
    }
    const subtotal = cartData.products.reduce((sum, item) => {
      return sum + (item.productId.price * item.quantity);
    }, 0);
    const tax = subtotal * 0.1;
    const total = subtotal + tax;
    cartContent.innerHTML = `
      <div class="cart-items">
        ${cartData.products.map(item => `
          <div class="cart-item">
            <div class="cart-item-info">
              <div class="cart-item-name">${escapeHtml(item.productId.name)}</div>
              <div class="cart-item-price">$${item.productId.price.toFixed(2)} har biri</div>
            </div>
            <div class="quantity-controls">
              <button class="quantity-btn" onclick="updateQuantity('${item.productId._id}', ${item.quantity - 1})" ${item.quantity <= 1 ? 'disabled' : ''}>−</button>
              <span style="min-width: 40px; text-align: center; font-weight: 600;">${item.quantity}</span>
              <button class="quantity-btn" onclick="updateQuantity('${item.productId._id}', ${item.quantity + 1})">+</button>
            </div>
            <div style="font-weight: 700; font-size: 16px;">$${(item.productId.price * item.quantity).toFixed(2)}</div>
            <button class="btn danger" onclick="removeFromCart('${item.productId._id}')">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
              </svg>
              O'chirish
            </button>
          </div>
        `).join('')}
      </div>
      <div class="cart-total">
        <div class="total-row">
          <span>Oraliq jami:</span>
          <span>$${subtotal.toFixed(2)}</span>
        </div>
        <div class="total-row">
          <span>Soliq (10%):</span>
          <span>$${tax.toFixed(2)}</span>
        </div>
        <div class="total-row final">
          <span>Jami:</span>
          <span>$${total.toFixed(2)}</span>
        </div>
        <button class="btn success lg mt" onclick="checkout()" style="width: 100%;">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
          </svg>
          Buyurtma berish
        </button>
      </div>
    `;
  }

  async function updateQuantity(productId, newQuantity) {
    if (newQuantity <= 0) {
      removeFromCart(productId);
      return;
    }
    try {
      // This uses PUT, which maps to updateCartItemQuantity on the backend
      await apiFetch('/cart', {
        method: 'PUT',
        body: JSON.stringify({
          productId: productId,
          quantity: newQuantity
        })
      });
      await loadCart();
      await loadStats();
      showNotification('Savatcha yangilandi!');
    } catch (error) {
      console.error('Error updating quantity:', error);
      showNotification('Savatchani yangilashda xatolik', 'error');
    }
  }

  async function removeFromCart(productId) {
    try {
      await apiFetch('/cart', {
        method: 'DELETE',
        body: JSON.stringify({
          productId: productId
        })
      });
      await loadCart();
      await loadStats();
      showNotification('Mahsulot savatchadan o\'chirildi!');
    } catch (error) {
      console.error('Error removing from cart:', error);
      showNotification('Mahsulotni o\'chirishda xatolik', 'error');
    }
  }

  async function checkout() {
    if (!cartData || !cartData.products || cartData.products.length === 0) {
      showNotification('Savatchangiz bo\'sh', 'error');
      return;
    }
    try {
      await apiFetch('/orders', {
        method: 'POST',
        body: JSON.stringify({
          products: cartData.products.map(item => ({
            productId: item.productId._id,
            quantity: item.quantity
          }))
        })
      });
      showNotification('Buyurtma muvaffaqiyatli berildi! Admin tomonidan tasdiqlanishi kutilmoqda.');
      await loadCart();
      await loadStats();
      showSection('orders');
    } catch (error) {
      console.error('Error creating order:', error);
      showNotification('Buyurtma berishda xatolik: ' + error.message, 'error');
    }
  }

  async function loadOrders() {
    ordersContent.innerHTML = `
      <div class="loading">
        <div class="spinner"></div>
        Buyurtmalar yuklanmoqda...
      </div>
    `;
    try {
      const orders = await apiFetch('/orders');
      ordersData = orders;
      renderOrders();
    } catch (error) {
      console.error('Error loading orders:', error);
      ordersContent.innerHTML = `
        <div class="empty-state">
          <svg class="empty-icon" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          <p>Buyurtmalarni yuklashda xatolik yuz berdi.</p>
          <button class="btn primary" onclick="loadOrders()">Qayta urinish</button>
        </div>
      `;
    }
  }

  function renderOrders() {
    if (ordersData.length === 0) {
      ordersContent.innerHTML = `
        <div class="empty-state">
          <svg class="empty-icon" fill="currentColor" viewBox="0 0 24 24">
            <path d="M19 7h-3V6a4 4 0 0 0-8 0v1H5a1 1 0 0 0-1 1v11a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V8a1 1 0 0 0-1-1zM10 6a2 2 0 0 1 4 0v1h-4V6zm8 13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V9h2v1a1 1 0 0 0 2 0V9h4v1a1 1 0 0 0 2 0V9h2v10z"/>
          </svg>
          <p>Hozircha buyurtmalar yo'q.</p>
          <a href="#" data-section="products" class="btn primary" onclick="showSection('products');">Xarid qilishni boshlash</a>
        </div>
      `;
      return;
    }
    const statusLabels = {
      pending: 'Kutilmoqda',
      processing: 'Jarayonda',
      shipped: 'Yuborildi',
      delivered: 'Yetkazildi'
    };
    const statusClasses = {
      pending: 'status-pending',
      processing: 'status-processing',
      shipped: 'status-shipped',
      delivered: 'status-delivered'
    };
    ordersContent.innerHTML = ordersData.map(order => `
      <div class="order-card">
        <div class="order-header">
          <div class="order-id">Buyurtma #${escapeHtml(order._id.substring(0, 8))}</div>
          <div class="order-status ${statusClasses[order.status] || ''}">${escapeHtml(statusLabels[order.status] || order.status)}</div>
        </div>
        <div class="order-meta">
          <div class="order-date">Buyurtma sanasi: ${new Date(order.createdAt).toLocaleDateString('uz-UZ')}</div>
          <div class="order-total">$${order.total.toFixed(2)}</div>
        </div>
        <div class="order-items">
          ${order.products.map(item => `
            <div class="order-item">
              <div>
                <div style="font-weight: 600;">${escapeHtml(item.productId.name || 'Mahsulot')}</div>
                <div class="muted small">Miqdor: ${item.quantity}</div>
              </div>
              <div style="font-weight: 600;">$${((item.productId.price || 0) * item.quantity).toFixed(2)}</div>
            </div>
          `).join('')}
        </div>
      </div>
    `).join('');
  }

  async function loadFaqs() {
    faqContent.innerHTML = `
      <div class="loading">
        <div class="spinner"></div>
        Savollar yuklanmoqda...
      </div>
    `;
    try {
      const faqs = await apiFetch('/faq');
      faqsData = faqs;
      renderFaqs();
    } catch (error) {
      console.error('Error loading FAQs:', error);
      faqContent.innerHTML = `
        <div class="empty-state">
          <svg class="empty-icon" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          <p>Savollarni yuklashda xatolik yuz berdi.</p>
          <button class="btn primary" onclick="loadFaqs()">Qayta urinish</button>
        </div>
      `;
    }
  }

  function renderFaqs() {
    if (faqsData.length === 0) {
      faqContent.innerHTML = `
        <div class="empty-state">
          <svg class="empty-icon" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 14h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
          </svg>
          <p>Hozircha FAQ mavjud emas.</p>
        </div>
      `;
      return;
    }
    faqContent.innerHTML = faqsData.map(faq => `
      <div class="faq-item">
        <div class="faq-question">${escapeHtml(faq.question)}</div>
        <div class="faq-answer">${escapeHtml(faq.answer)}</div>
      </div>
    `).join('');
  }

  async function loadAnalytics() {
    if (currentUser.role !== 'admin') {
      analyticsContent.innerHTML = `
        <div class="empty-state">
          <p>Bu bo‘limga faqat administrator kirishi mumkin.</p>
        </div>
      `;
      return;
    }
    analyticsContent.innerHTML = `
      <div class="loading">
        <div class="spinner"></div>
        Tahlillar yuklanmoqda...
      </div>
    `;
    try {
      const [sales, tops, activity] = await Promise.all([
        apiFetch('/analytics/sales'),
        apiFetch('/analytics/top-products'),
        apiFetch('/analytics/user-activity')
      ]);
      salesReportData = sales;
      topProductsData = tops;
      userActivityData = activity;
      renderAnalytics();
    } catch (error) {
      console.error('Error loading analytics:', error);
      analyticsContent.innerHTML = `
        <div class="empty-state">
          <svg class="empty-icon" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          <p>Tahlillarni yuklashda xatolik yuz berdi.</p>
          <button class="btn primary" onclick="loadAnalytics()">Qayta urinish</button>
        </div>
      `;
    }
  }

  function renderAnalytics() {
    analyticsContent.innerHTML = `
      <div class="analytics-grid">
        <div class="analytics-card">
          <div class="analytics-title">Sotuvlar</div>
          <ul class="analytics-list">
            ${salesReportData.length === 0 ? '<li class="analytics-list-item">Ma\'lumot yo\'q</li>' : salesReportData.map(item => `
              <li class="analytics-list-item">
                <span>${escapeHtml(item.date)}</span>
                <span>$${item.total.toFixed(2)}</span>
              </li>
            `).join('')}
          </ul>
        </div>
        <div class="analytics-card">
          <div class="analytics-title">Eng yaxshi mahsulotlar</div>
          <ul class="analytics-list">
            ${topProductsData.length === 0 ? '<li class="analytics-list-item">Ma\'lumot yo\'q</li>' : topProductsData.map(item => `
              <li class="analytics-list-item">
                <span>${escapeHtml(item.name)}</span>
                <span>$${item.total.toFixed(2)}</span>
              </li>
            `).join('')}
          </ul>
        </div>
        <div class="analytics-card">
          <div class="analytics-title">Foydalanuvchi faolligi</div>
          <ul class="analytics-list">
            ${userActivityData.length === 0 ? '<li class="analytics-list-item">Ma\'lumot yo\'q</li>' : userActivityData.map(item => `
              <li class="analytics-list-item">
                <span>${escapeHtml(item.date)}</span>
                <span>${item.users} foydalanuvchi</span>
              </li>
            `).join('')}
          </ul>
        </div>
      </div>
    `;
  }

  function logout() {
    localStorage.removeItem(TOKEN_KEY);
    localStorage.removeItem(USER_KEY);
    showNotification('Tizimdan muvaffaqiyatli chiqildi!');
    setTimeout(() => {
      window.location.href = 'login.html';
    }, 1000);
  }

  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
  `;
  document.head.appendChild(style);
</script>
</body>
</html>
